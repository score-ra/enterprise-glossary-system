upstream skosmos_backend {
    server skosmos:80;
}

upstream fuseki_backend {
    server fuseki:3030;
}

server {
    listen 80;
    server_name _;

    # ================================================================
    # SKOSMOS UI and REST API (public read access)
    # ================================================================

    # SKOSMOS web UI -- public read
    location / {
        proxy_pass http://skosmos_backend;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ================================================================
    # Fuseki SPARQL read endpoint (public)
    # ================================================================

    location /sparql {
        # Read-only SPARQL queries -- no auth required
        limit_except GET POST {
            deny all;
        }
        proxy_pass http://fuseki_backend/skosmos/sparql;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ================================================================
    # Fuseki admin/write endpoints (require authentication)
    # ================================================================

    # SPARQL Update -- editors and admins only
    location /fuseki/update {
        auth_basic "EGMS Write Access";
        auth_basic_user_file /etc/nginx/auth/htpasswd;
        proxy_pass http://fuseki_backend/skosmos/update;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Graph Store Protocol (data upload) -- editors and admins only
    location /fuseki/data {
        auth_basic "EGMS Write Access";
        auth_basic_user_file /etc/nginx/auth/htpasswd;
        proxy_pass http://fuseki_backend/skosmos/data;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # File upload -- admins only
    location /fuseki/upload {
        auth_basic "EGMS Admin Access";
        auth_basic_user_file /etc/nginx/auth/htpasswd-admin;
        proxy_pass http://fuseki_backend/skosmos/upload;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Fuseki admin panel -- admins only
    location /fuseki-admin/ {
        auth_basic "EGMS Admin Access";
        auth_basic_user_file /etc/nginx/auth/htpasswd-admin;
        proxy_pass http://fuseki_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ================================================================
    # Health check endpoint (no auth)
    # ================================================================

    location /health {
        access_log off;
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }
}
